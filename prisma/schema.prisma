// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Setores (Centro de Custo)
model Setor {
  id           String   @id @default(cuid())
  centroCusto  String   @unique
  descricao    String
  almoxarifado String
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  // Relação com blocos do grid
  blocks Block[]
}

// Produtos
model Produto {
  id          String   @id @default(cuid())
  codigo      String   @unique
  descricao   String
  centroCusto String   @default("315111") // Centro de custo do almoxarifado
  saldo       Int      @default(0)        // Quantidade em estoque
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  solicitacoes SolicitacaoAlmoxarifado[]

  @@index([centroCusto])
}

// Blocos do Grid (endereços)
model Block {
  id         String   @id @default(cuid())
  gridKey    String   // "row-col" format
  setorId    String
  setor      Setor    @relation(fields: [setorId], references: [id], onDelete: Cascade)
  
  // Dados do bloco
  type       String   @default("endereco") // "endereco" ou "letter"
  rua        String?
  coluna     String?
  nivel      String?
  tipo       String?  // "COLUNA" ou "NIVEL"
  altura     String?
  produto    String?
  descricao  String?
  observacao String?
  tipoCaixa  String?
  blockColor String   @default("gray")
  almo       String?
  
  // Para blocos tipo NIVEL (gavetas)
  enderecos  Json?    // Array de endereços internos
  
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@unique([setorId, gridKey])
  @@index([setorId])
}

// Configuração do Grid por Setor
model GridConfig {
  id        String   @id @default(cuid())
  setorId   String   @unique
  cols      Int      @default(50)
  rows      Int      @default(50)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// Usuários do Sistema
model User {
  id        String   @id @default(cuid())
  username  String   @unique
  password  String   // Senha criptografada (hash)
  name      String?
  role      String   @default("admin") // "admin" ou "user"
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// Solicitações de Cadastro (Pendente de Aprovação)
model RegistrationRequest {
  id        String   @id @default(cuid())
  username  String   @unique
  password  String
  name      String
  createdAt DateTime @default(now())
}

// Status do Inventário por Setor (Planta)
model InventarioSetor {
  id           String   @id @default(cuid())
  setorCodigo  String   @unique // "314111", "315111", "317111", etc.
  emInventario Boolean  @default(false)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
}

// ============================================
// SISTEMA DE MANUTENÇÃO
// ============================================

// Bens/Máquinas/Equipamentos
model Bem {
  id          String   @id @default(cuid())
  codigo      String   @unique // Código do bem (pode ser lido via QR Code)
  descricao   String   // Nome/descrição do equipamento
  centroCusto String   // Centro de Custo onde o bem está
  estacao     String?  // Estação de trabalho
  localizacao String?  // Localização física
  qrCode      String?  // QR Code único (se diferente do código)
  status      String   @default("operacional") // operacional, em_manutencao, inativo
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relações
  ordensServico OrdemServico[]

  @@index([centroCusto])
  @@index([codigo])
}

// Técnicos de Manutenção
model Tecnico {
  id           String   @id @default(cuid())
  matricula    String   @unique
  nome         String
  especialidade String  // Elétrica, Mecânica, Geral
  ativo        Boolean  @default(true)
  telefone     String?
  email        String?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  // Relações
  ordensServico OrdemServico[]
  pausas        PausaOS[]
  solicitacoes  SolicitacaoAlmoxarifado[]
}

// Ordens de Serviço
model OrdemServico {
  id              String    @id @default(cuid())
  numero          Int       @unique @default(autoincrement()) // Número sequencial da OS
  tipo            String    @default("OS") // "SS" (Solicitação de Serviço) ou "OS" (Ordem de Serviço)
  
  // Dados da Solicitação
  bemId           String
  bem             Bem       @relation(fields: [bemId], references: [id])
  centroCusto     String
  estacao         String?
  tipoManutencao  String    // Elétrica, Mecânica, Avaliação
  tipoManutencaoCategoria String @default("CORRETIVA") // PREVENTIVA ou CORRETIVA
  prioridade      String    @default("normal") // baixa, normal, alta, urgente
  fila            Int?      // Fila de prioridade numérica (000)
  observacaoAbertura String?
  solicitante     String    // Nome do solicitante
  
  // Status e Fluxo
  status          String    @default("aberta") // aberta, em_analise, em_fila, em_execucao, pausada, concluida_tecnica, encerrada
  
  // Atribuição
  tecnicoId       String?
  tecnico         Tecnico?  @relation(fields: [tecnicoId], references: [id])
  
  // Datas do Fluxo
  dataAbertura    DateTime  @default(now())
  dataAtribuicao  DateTime?
  dataInicio      DateTime? // Quando o técnico iniciou
  dataFim         DateTime? // Quando o técnico finalizou
  dataEncerramento DateTime? // Quando foi encerrada no sistema
  
  // Execução (preenchido pelo técnico)
  problemaId      String?
  problema        ProblemaOS? @relation(fields: [problemaId], references: [id])
  causaId         String?
  causa           CausaOS?  @relation(fields: [causaId], references: [id])
  solucaoId       String?
  solucao         SolucaoOS? @relation(fields: [solucaoId], references: [id])
  observacaoTecnica String?
  
  // Extras
  horaExtra       Boolean   @default(false)
  statusFinalBem  String?   // operacional, restricao
  
  // Quem encerrou
  encerradoPor    String?
  
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  // Relações
  pausas          PausaOS[]
  anexos          AnexoOS[]
  materiais       MaterialOS[]

  @@index([status])
  @@index([tecnicoId])
  @@index([bemId])
  @@index([centroCusto])
  @@index([dataAbertura])
  @@index([tipo])
}

// Pausas nas Ordens de Serviço
model PausaOS {
  id              String   @id @default(cuid())
  ordemServicoId  String
  ordemServico    OrdemServico @relation(fields: [ordemServicoId], references: [id], onDelete: Cascade)
  tecnicoId       String
  tecnico         Tecnico  @relation(fields: [tecnicoId], references: [id])
  
  motivoPausaId   String
  motivoPausa     MotivoPausa @relation(fields: [motivoPausaId], references: [id])
  observacao      String?
  
  dataInicio      DateTime @default(now())
  dataFim         DateTime?
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([ordemServicoId])
}

// Motivos de Pausa (tabela auxiliar)
model MotivoPausa {
  id        String   @id @default(cuid())
  codigo    String   @unique
  descricao String
  ativo     Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  pausas    PausaOS[]
}

// Materiais/Peças utilizados na OS
model MaterialOS {
  id              String   @id @default(cuid())
  ordemServicoId  String
  ordemServico    OrdemServico @relation(fields: [ordemServicoId], references: [id], onDelete: Cascade)
  
  codigoProduto   String
  descricao       String
  quantidade      Float
  unidade         String?
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([ordemServicoId])
}

// Anexos (fotos/vídeos) da OS
model AnexoOS {
  id              String   @id @default(cuid())
  ordemServicoId  String
  ordemServico    OrdemServico @relation(fields: [ordemServicoId], references: [id], onDelete: Cascade)
  
  tipo            String   // foto, video
  url             String   // URL do arquivo
  descricao       String?
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([ordemServicoId])
}

// Lista de Problemas (PCS - Problema)
model ProblemaOS {
  id        String   @id @default(cuid())
  codigo    String   @unique
  descricao String
  ativo     Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  ordensServico OrdemServico[]
}

// Lista de Causas (PCS - Causa)
model CausaOS {
  id        String   @id @default(cuid())
  codigo    String   @unique
  descricao String
  ativo     Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  ordensServico OrdemServico[]
}

// Lista de Soluções (PCS - Solução)
model SolucaoOS {
  id        String   @id @default(cuid())
  codigo    String   @unique
  descricao String
  ativo     Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  ordensServico OrdemServico[]
}

// ============================================
// SOLICITAÇÕES AO ALMOXARIFADO
// ============================================

model SolicitacaoAlmoxarifado {
  id                 String       @id @default(cuid())
  
  // Produto solicitado
  produtoId          String
  produto            Produto      @relation(fields: [produtoId], references: [id])
  
  // Técnico que solicitou
  tecnicoId          String
  tecnico            Tecnico      @relation(fields: [tecnicoId], references: [id])
  
  // OS relacionada (opcional)
  ordemServicoId     String?
  
  // Info do equipamento/bem (snap do momento da solicitacao)
  bemDescricao       String?
  bemLocalizacao     String?
  centroCusto        String?      // Centro de custo do equipamento
  
  // Quantidades
  quantidade         Int          // Quantidade solicitada pelo técnico
  quantidadeAtendida Int          @default(0) // Quantidade já atendida pelo almoxarifado
  
  // Status: pendente, parcial, atendida, cancelada
  status             String       @default("pendente")
  
  criadoEm           DateTime     @default(now())
  atualizadoEm       DateTime     @updatedAt

  @@index([produtoId])
  @@index([tecnicoId])
  @@index([status])
  @@index([centroCusto])
}
